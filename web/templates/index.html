{% extends "base.html" %}
{% block title %}Главная страница{% endblock %}
{% block content %}
<div class="row justify-content-xl-center mt-1">
  <div class="col-md-3 mt-3">
    <div class="card">
      <div class="card-header" id="infoCardHeader"></div>
      <div class="card-body">
        <table class="table table-sm table-borderless mb-0">
          <tbody id="infoTableBody"></tbody>
        </table>
      </div>
    </div>
    <p class="lead mb-3 mt-4">Выбрать данные:</p>
    <div class="row g-3">
      <div class="col-sm-6">
        <label for="dateFrom" class="form-label">с</label>
        <input type="date" id="dateFrom" class="form-control p-1" name="dateFrom" value="2022-01-01" min="2013-01-01" max="{% now 'Y-m-d' %}">
      </div>
      <div class="col-sm-6">
        <label for="dateTo" class="form-label">по</label>
        <input type="date" id="dateTo" class="form-control p-1" name="dateTo" value="{% now 'Y-m-d' %}" min="2013-01-01" max="{% now 'Y-m-d' %}">
      </div>
      <div class="col-sm-12">
        <label for="selectReservoirs" class="form-label">водохранилище</label>
        <select id="selectReservoirs" class="form-select p-1" name ="selectReservoirs"></select>
      </div>
      <div class="row justify-content-end mt-4 p-0">
        <div class="col-sm-auto p-0">
          <button id="updateButton" type="button" class="btn btn-dark pb-1 pt-1">Показать</button>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-8 mt-2">
    <div class="row justify-content-center">
      <div class="row">
        <canvas id="levelsChart" width="400" height="225"></canvas>
      </div>
      <div class="row">
        <canvas id="flowsChart" width="400" height="225"></canvas>
      </div>
    </div>
  </div>
  <div class="col-md-1">
  </div>
</div>
{% block jquery %}
  <script>
    var reservoirs = [];

    $.ajax({
      url: "{% url 'reservoirs:v1:reservoir-list' %}",
      success: function(data) {
        reservoirs = data;
        $("#selectReservoirs option").remove();
        for (var i in data)
          $("#selectReservoirs").append("<option val=" + data[i].slug + ">" + data[i].name + "</option>");
        updateContent();
      },          
      error: function(error_data) {
        console.log(error_data)
      }
    });

    $(document).ready(function() {
      $("#updateButton").click(function() {
        updateContent();
      });
    });

    $(document).ready(function() {
      $("#dateFrom").bind("keydown", function(event) {
        var keycode = (event.keyCode ? event.keyCode : (event.which ? event.which : event.charCode));
        if (keycode == 13) {
          document.getElementById('updateButton').click();
          return false;
        } else {
          return true;
        }
      });
    });

    $(document).ready(function() {
      $("#dateTo").bind("keydown", function(event) {
        var keycode = (event.keyCode ? event.keyCode : (event.which ? event.which : event.charCode));
        if (keycode == 13) {
          document.getElementById('updateButton').click();
          return false;
        } else {
          return true;
        }
      });
    });

    function updateContent() {
      var slug  = $("#selectReservoirs").find("option:selected").attr('val');
      var reservoir = getReservoir(slug);
      var start = $("#dateFrom").val();
      var end = $("#dateTo").val();
      setInfo(reservoir);
      getSituations(reservoir, start, end);
    };

    function getReservoir(slug) {
      if (slug == null) {
        return reservoirs[0]
      }
      return reservoirs.find(r => r.slug == slug)
    };

    function getSituations(reservoir, start, end) {
      var url = "{% url 'reservoirs:v1:situation-list' %}?reservoir=" + reservoir.slug
      if (start !== null) {
        url = url + "&start=" + start
      }
      if (end !== null) {
        url = url + "&end=" + end
      }
      $.ajax({
        method: "GET",
        url: url,
        success: function(data) {
          setCharts(formatData(data));
        },
        error: function(error_data) {
          console.log(error_data);
        }
      });
    };

    function formatData(data) {
      let dates = []
      let levels = []
      let inflows = []
      let outflows = []
      let spillway = []

      for(var i in data)
        dates.push(data[i].date);
      for(var i in data)
        levels.push(data[i].level);
      for(var i in data)
        inflows.push(data[i].inflow);
      for(var i in data)
        outflows.push(data[i].outflow);
      for(var i in data)
        spillway.push(data[i].spillway);
      return {
        dates: dates,
        levels: levels,
        inflows: inflows,
        outflows: outflows,
        spillway: spillway
      }
    };

    function setInfo(reservoir) {
      $("#infoCardHeader p").remove();
      $("#infoCardHeader").append("<p class='lead mb-0'>" + reservoir.name + " водохранилище</p>");

      $("#infoTableBody tr").remove();
      if (reservoir.force_level !== null) {$("#infoTableBody").append("<tr><td>ФПУ</td><td>" + reservoir.force_level + " м</td></tr>")};
      if (reservoir.normal_level !== null) {$("#infoTableBody").append("<tr><td>НПУ</td><td>" + reservoir.normal_level + " м</td></tr>")};
      if (reservoir.dead_level !== null) {$("#infoTableBody").append("<tr><td>УМО</td><td>" + reservoir.dead_level + " м</td></tr>")};
      if (reservoir.full_volume !== null) {$("#infoTableBody").append("<tr><td>Полный объём</td><td>" + reservoir.full_volume + " км3</td></tr>")};
      if (reservoir.useful_volume !== null) {$("#infoTableBody").append("<tr><td>Полезный объём</td><td>" + reservoir.useful_volume + " км3</td></tr>")};
      if (reservoir.area !== null) {$("#infoTableBody").append("<tr><td>Площадь</td><td>" + reservoir.area + " км2</td></tr>")};
      if (reservoir.max_depth !== null) {$("#infoTableBody").append("<tr><td>Макс. глубина</td><td>" + reservoir.max_depth + " м</td></tr>")};
    };

    function setCharts(data) {
      levelsChart.data.labels = data.dates;
      levelsChart.data.datasets[0].data = data.levels;
      levelsChart.update();

      flowsChart.data.labels = data.dates;
      flowsChart.data.datasets[0].data = data.inflows;
      flowsChart.data.datasets[1].data = data.outflows;
      flowsChart.data.datasets[2].data = data.spillway;
      flowsChart.update();
    };

    const flows_ctx = document.getElementById("flowsChart").getContext("2d");
    const levels_ctx = document.getElementById("levelsChart").getContext("2d");

    options = {
      scales: {
        y: {
            beginAtZero: false
        }
      },
      elements: {
        point: {
          radius: 0
        }
      },
      plugins: {
        legend: {
          display: true,
          position: "bottom",
          labels: {
              boxHeight: 0
          }
        }
      }
    };
    var levels_data = {
      labels: [],
      datasets: [{
        label: "УВБ, м",
        data: [],
        backgroundColor: "rgba(255, 159, 64, 0.2)",
        borderColor: "rgba(255, 159, 64, 1)",
        borderWidth: 1,
        fill: true,
      }]
    };
    var levels_config = {
      type: "line",
      data: levels_data,
      options: options
    };
    var flows_data = {
      labels: [],
      datasets: [{
        label: "Приток, м\u00B3/с",
        data: [],
        backgroundColor: "rgba(255, 99, 132, 0.2)",
        borderColor: "rgba(255, 99, 132, 1)",
        borderWidth: 1,
        fill: true,
      },
      {
        label: "Сброс, м\u00B3/с",
        data: [],
        backgroundColor: "rgba(54, 162, 235, 0.2)",
        borderColor: "rgba(54, 162, 235, 1)",
        borderWidth: 1,
        fill: true,
      },
      {
        label: "Холостой сброс, м\u00B3/с",
        data: [],
        backgroundColor: "rgba(153, 102, 255, 0.2)",
        borderColor: "rgba(153, 102, 255, 1)",
        borderWidth: 1,
        fill: true,
      }]
    };
    var flows_config = {
      type: "line",
      data: flows_data,
      options: options
    };
    const levelsChart = new Chart(levels_ctx, levels_config);
    const flowsChart = new Chart(flows_ctx, flows_config);
  </script>
{% endblock %}
{% endblock %}
