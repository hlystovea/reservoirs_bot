{% extends "base.html" %}
{% block title %}Главная страница{% endblock %}
{% block content %}
{% block jquery %}
<script>
  $.ajax({
    method: "GET",
    url: "{% url 'reservoirs:v1:reservoir-list' %}",
    success: function(data){
      $("#selectReservoirs option").remove();
      for (var i in data)
        $("#selectReservoirs").append("<option val=" + data[i].slug + ">" + data[i].name + "</option>");
    },          
    error: function(error_data){
      console.log(error_data)
    }
  });

  $(function(){
    var dateFormat = "yy-mm-dd",
    options = {
      yearRange: "2013:2022",
      changeMonth: true,
      changeYear: true,
      numberOfMonths: 1,
      dateFormat: "yy-mm-dd"
    },
    dateFrom = $("#dateFrom").datepicker(options).on("change", function(){
      dateTo.datepicker("option", "minDate", getDate(this));
    }),
    dateTo = $("#dateTo").datepicker(options).on("change", function(){
      dateFrom.datepicker("option", "maxDate", getDate(this));
    });

    function getDate(element){
      var date;
      try {
        date = $.datepicker.parseDate(dateFormat, element.value);
      } catch( error ) {
        date = null;
      }
      return date;
    }
  });
</script>

<div class="row justify-content-xl-center mt-4">
  <div class="col col-sm-3">
    <h5 class="mb-3">Выбрать данные</h5>
    <div class="row g-3">
      <div class="col-sm-6">
        <label for="dateFrom" class="form-label">с</label>
        <input type="text" id="dateFrom" class="form-control" name="dateFrom" value="2022-01-01">
      </div>
      <div class="col-sm-6">
        <label for="dateTo" class="form-label">по</label>
        <input type="text" id="dateTo" class="form-control" name="dateTo" value="{% now 'Y-m-d' %}">
      </div>
      <div class="col-sm-12">
        <label for="selectReservoirs" class="form-label">водохранилище</label>
        <select id="selectReservoirs" class="form-select" name ="selectReservoirs"></select>
      </div>
      <div class="col-sm-12">
        <button id="updateButton" type="button" class="btn btn-dark mt-2">Показать</button>
      </div>
    </div>
  </div>
  <div class="col-md-8">
    <div class="row">
      <canvas id="levelsChart"></canvas>
    </div>
    <div class="row">
      <canvas id="flowsChart"></canvas>
    </div>
  </div>
  <div class="col col-sm">
  </div>
</div>

  <script>
    function getUrl(){
      var slug  = $("#selectReservoirs").find("option:selected").attr('val')
      if (slug == null) {
        slug = "sayano"
      }
      var start = $("#dateFrom").val()
      var end = $("#dateTo").val()
      var url = "{% url 'reservoirs:v1:situation-list' %}?reservoir=" + slug + "&start=" + start + "&end=" + end
      return url;
    }
    setCharts(getUrl())
    $(document).ready(function() {
      $("#updateButton").click(function(){
        setCharts(getUrl())
      });
    });
    function setCharts(url){
      $.ajax({
        method: "GET",
        url: url,
        success: function(data){
          let dates = []
          let levels = []
          let inflows = []
          let outflows = []
          let spillway = []

          for(var i in data)
            dates.push(data[i].date);
          for(var i in data)
            levels.push(data[i].level);
          for(var i in data)
            inflows.push(data[i].inflow);
          for(var i in data)
            outflows.push(data[i].outflow);
          for(var i in data)
            spillway.push(data[i].spillway);

          levelsChart.data.labels = dates;
          levelsChart.data.datasets[0].data = levels;
          levelsChart.update();

          flowsChart.data.labels = dates;
          flowsChart.data.datasets[0].data = inflows;
          flowsChart.data.datasets[1].data = outflows;
          flowsChart.data.datasets[2].data = spillway;
          flowsChart.update();
        },
        error: function(error_data){
          console.log("error")
          console.log(error_data)
        }
      })
    };
    const flows_ctx = document.getElementById("flowsChart").getContext("2d");
    const levels_ctx = document.getElementById("levelsChart").getContext("2d");
    options = {
      scales: {
        y: {
            beginAtZero: false
        }
      },
      elements: {
        point: {
          radius: 0
        }
      },
      plugins: {
        legend: {
          display: true,
          position: "bottom",
          labels: {
              boxHeight: 0
          }
        }
      }
    };
    var levels_data = {
      labels: [],
      datasets: [{
        label: "УВБ, м",
        data: [],
        backgroundColor: "rgba(255, 159, 64, 0.2)",
        borderColor: "rgba(255, 159, 64, 1)",
        borderWidth: 1,
        fill: true,
      }]
    };
    var levels_config = {
      type: "line",
      data: levels_data,
      options: options
    };
    var flows_data = {
      labels: [],
      datasets: [{
        label: "Приток, м\u00B3/с",
        data: [],
        backgroundColor: "rgba(255, 99, 132, 0.2)",
        borderColor: "rgba(255, 99, 132, 1)",
        borderWidth: 1,
        fill: true,
      },
      {
        label: "Сброс, м\u00B3/с",
        data: [],
        backgroundColor: "rgba(54, 162, 235, 0.2)",
        borderColor: "rgba(54, 162, 235, 1)",
        borderWidth: 1,
        fill: true,
      },
      {
        label: "Холостой сброс, м\u00B3/с",
        data: [],
        backgroundColor: "rgba(153, 102, 255, 0.2)",
        borderColor: "rgba(153, 102, 255, 1)",
        borderWidth: 1,
        fill: true,
      }]
    };
    var flows_config = {
      type: "line",
      data: flows_data,
      options: options
    };
    const levelsChart = new Chart(levels_ctx, levels_config);
    const flowsChart = new Chart(flows_ctx, flows_config);
  </script>
{% endblock %}
{% endblock %}
